<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: head('Peer Support Forum - MindWell')}">
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-700 dark:text-slate-300 antialiased">
    <div class="flex h-screen">
        <div th:replace="~{fragments/sidebar-student :: sidebar('forum')}"></div>

        <main class="flex-1 p-8 overflow-y-auto">
            <header class="flex justify-between items-start mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white">Peer Support Forum</h2>
                    <p class="text-slate-500 dark:text-slate-400 mt-1">Share your thoughts anonymously and support each
                        other.</p>
                </div>
                <button
                    class="flex items-center gap-2 bg-primary text-white font-semibold px-5 py-3 rounded-lg hover:bg-indigo-700 transition-colors"
                    onclick="document.getElementById('newPostModal').classList.remove('hidden')">
                    <span class="material-symbols-outlined">add</span>
                    New Post
                </button>
            </header>
            <!-- Local styles for clamping long content to 3 lines in list view -->
            <style>
                .clamp-3 {
                    display: -webkit-box;
                    -webkit-line-clamp: 3;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                }
            </style>

            <!-- Forum Topics/Tabs -->
            <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                <a th:href="@{/student/forum}"
                    th:classappend="${selectedCategory == 'all'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    All Topics
                </a>
                <a th:href="@{/student/forum(category='anxiety')}"
                    th:classappend="${selectedCategory == 'anxiety'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    Anxiety
                </a>
                <a th:href="@{/student/forum(category='stress')}"
                    th:classappend="${selectedCategory == 'stress'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    Stress
                </a>
                <a th:href="@{/student/forum(category='depression')}"
                    th:classappend="${selectedCategory == 'depression'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    Depression
                </a>
                <a th:href="@{/student/forum(category='academic')}"
                    th:classappend="${selectedCategory == 'academic'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    Academic
                </a>
                <a th:href="@{/student/forum(category='myposts')}"
                    th:classappend="${selectedCategory == 'myposts'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    <span class="material-symbols-outlined text-sm">person</span>
                    My Posts
                </a>
            </div>

            <!-- Your Pending Posts Section -->
            <div th:if="${pendingPosts != null && !pendingPosts.isEmpty()}" class="mb-6">
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400">schedule</span>
                        <h3 class="font-bold text-slate-900 dark:text-white">Your Pending Posts</h3>
                        <span class="text-sm text-slate-600 dark:text-slate-400">(<span th:text="${pendingPosts.size()}">0</span> awaiting approval)</span>
                    </div>
                    <div class="space-y-3" id="pendingPostsContainer">
                        <div th:each="post,iterStat : ${pendingPosts}" 
                            th:classappend="${iterStat.index >= 3} ? 'hidden' : ''"
                            class="bg-white dark:bg-slate-900 p-4 rounded-lg border border-slate-200 dark:border-slate-800 pending-post-item">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-yellow-600 bg-yellow-100 dark:bg-yellow-900/50">Pending Approval</span>
                                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-purple-600 bg-purple-100 dark:bg-purple-900/50"
                                            th:text="${post.category.substring(0, 1).toUpperCase() + post.category.substring(1)}">Category</span>
                                        <span class="text-sm text-slate-400" th:text="${post.timeAgo}">2 hours ago</span>
                                    </div>
                                    <h4 class="font-semibold text-slate-900 dark:text-white mb-1" th:text="${post.title}">Post Title</h4>
                                    <p class="text-sm text-slate-600 dark:text-slate-400 clamp-3" th:text="${post.content}">Post content preview...</p>
                                </div>
                                <button class="flex items-center gap-1 text-slate-500 hover:text-red-600 transition-colors"
                                    th:onclick="|deletePost(${post.id})|">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button th:if="${pendingPosts.size() > 3}" 
                        class="w-full mt-3 px-4 py-2 text-sm font-medium text-yellow-600 hover:bg-yellow-100 dark:hover:bg-yellow-900/30 rounded-lg transition-colors"
                        onclick="togglePendingPosts()"
                        id="togglePendingBtn"
                        data-expanded="false">
                        View All (<span th:text="${pendingPosts.size()}">0</span>)
                    </button>
                </div>
            </div>

            <!-- Sorting Controls -->
            <div class="flex justify-end gap-2 mb-6">
                <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                    <span>Sort by:</span>
                    <a th:href="@{/student/forum(category=${selectedCategory}, sort='time')}"
                        th:classappend="${sortBy == 'time' or sortBy == null} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-100 dark:hover:bg-slate-800'"
                        class="px-3 py-1.5 rounded-lg font-medium text-sm transition-colors">
                        <span class="material-symbols-outlined text-sm">schedule</span>
                        Newest
                    </a>
                    <a th:href="@{/student/forum(category=${selectedCategory}, sort='likes')}"
                        th:classappend="${sortBy == 'likes'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-100 dark:hover:bg-slate-800'"
                        class="px-3 py-1.5 rounded-lg font-medium text-sm transition-colors">
                        <span class="material-symbols-outlined text-sm">favorite</span>
                        Most Liked
                    </a>
                </div>
            </div>
            <div id="postsList" class="space-y-4">
                <div th:if="${posts.isEmpty()}" class="text-center py-12">
                    <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">comment</span>
                    <p class="text-slate-500 text-lg">No posts yet. Be the first to share your thoughts!</p>
                </div>

                <div th:each="post : ${posts}"
                    class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800"
                    th:attr="data-post-id=${post.id}">
                    <div class="flex items-start gap-4">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full flex items-center justify-center text-white font-bold">
                            <span th:text="${post.authorDisplayName.charAt(0)}">A</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="font-semibold text-slate-900 dark:text-white"
                                    th:text="${post.authorDisplayName}">Anonymous</span>
                                <span class="text-xs text-slate-400" th:text="'• ' + ${post.timeAgo}">• 2 hours ago</span>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-purple-600 bg-purple-100 dark:bg-purple-900/50"
                                    th:text="${post.category.substring(0, 1).toUpperCase() + post.category.substring(1)}">Anxiety</span>
                            </div>
                            <h4 class="text-lg font-semibold text-slate-800 dark:text-white mb-2 cursor-pointer hover:text-primary transition-colors" 
                                th:text="${post.title}"
                                th:onclick="|window.location.href='/student/forum/${post.id}'|">
                                Post Title
                            </h4>
                            <p class="text-slate-600 dark:text-slate-400 clamp-3" th:text="${post.content}">Post content goes
                                here</p>
                            <a th:if="${#strings.length(post.content) > 200}"
                               th:href="@{'/student/forum/' + ${post.id}}"
                               class="mt-2 inline-flex items-center text-primary hover:text-indigo-700 text-sm font-medium">
                                Show more
                                <span class="material-symbols-outlined text-sm ml-1">chevron_right</span>
                            </a>
                            <div class="flex items-center gap-6 mt-4">
                                <button
                                    th:class="'like-btn flex items-center gap-1 hover:text-red-500 transition-colors ' + (${likedPostIds != null && likedPostIds.contains(post.id)} ? 'text-red-500' : 'text-slate-500')"
                                    th:attr="onclick='likePost(' + ${post.id} + ')'">
                                    <span class="material-symbols-outlined text-xl">favorite</span>
                                    <span class="like-count" th:text="${post.likeCount}">0</span>
                                </button>
                                <button
                                    class="flex items-center gap-1 text-slate-500 hover:text-primary transition-colors"
                                    th:onclick="|window.location.href='/student/forum/${post.id}'|">
                                    <span class="material-symbols-outlined text-xl">chat_bubble</span>
                                    <span class="comment-count" th:text="${post.commentCount}">0</span>
                                    <span>replies</span>
                                </button>
                                <!-- Owner-only actions -->
                                <div th:if="${userOwnedPostIds != null && userOwnedPostIds.contains(post.id)}" class="flex items-center gap-2 ml-auto">
                                    <button class="flex items-center gap-1 text-slate-500 hover:text-red-600 transition-colors"
                                        th:onclick="|deletePost(${post.id})|">
                                        <span class="material-symbols-outlined text-lg">delete</span>
                                        <span class="text-sm">Delete</span>
                                    </button>
                                </div>
                                <!-- Report button - only show if not own post -->
                                <button th:if="${userOwnedPostIds == null || !userOwnedPostIds.contains(post.id)}"
                                    th:disabled="${userFlaggedPosts != null && userFlaggedPosts[post.id]}"
                                    th:classappend="${userFlaggedPosts != null && userFlaggedPosts[post.id]} ? 'opacity-50 cursor-not-allowed' : ''"
                                    class="flex items-center gap-1 text-slate-500 hover:text-red-500 transition-colors ml-auto h-fit disabled:hover:text-slate-500"
                                    th:attr="onclick=!${userFlaggedPosts != null && userFlaggedPosts[post.id]} ? 'reportPost(' + ${post.id} + ')' : ''">
                                    <span class="material-symbols-outlined text-xl">flag</span>
                                    <span class="text-sm" th:text="${userFlaggedPosts != null && userFlaggedPosts[post.id]} ? 'Already Reported' : 'Report'">Report</span>
                                </button>
                            </div>
                            <!-- Comments Section -->
                            <div class="hidden mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 space-y-3 comments-section">
                                <div th:each="comment,iterStat : ${post.comments}" 
                                    th:classappend="${iterStat.index >= 10} ? 'hidden' : ''"
                                    class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg comment-item">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-medium text-sm" th:text="${comment.authorDisplayName}">Author</span>
                                        <span class="text-xs text-slate-400" th:text="'• ' + ${comment.timeAgo}">• 1 hour ago</span>
                                    </div>
                                    <p class="text-sm text-slate-600 dark:text-slate-400" th:text="${comment.content}">Comment
                                        content</p>
                                </div>
                                <div th:if="${post.comments.size() > 10}" class="pt-2 text-center">
                                    <button 
                                        class="text-primary hover:text-indigo-700 font-medium text-sm transition-colors load-more-comments"
                                        th:attr="onclick='loadMoreComments(this, ' + ${post.id} + ')'">
                                        Load more comments (<span class="hidden-count" th:text="${post.comments.size() - 10}"></span>)
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <div class="flex gap-2 mb-2">
                                        <input type="text" placeholder="Write a supportive comment..."
                                            class="flex-1 px-3 py-2 text-sm bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-primary focus:border-primary comment-input" />
                                        <button
                                            class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-indigo-700"
                                            th:attr="onclick='addComment(' + ${post.id} + ', this)'">Reply</button>
                                    </div>
                                    <label class="flex items-center gap-2 text-xs text-slate-500 cursor-pointer">
                                        <input type="checkbox" class="comment-anonymous-checkbox rounded border-slate-300 text-primary focus:ring-primary" checked />
                                        <span>Post anonymously</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Post Modal -->
    <div id="newPostModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-900 rounded-xl w-full max-w-lg">
            <div class="p-6 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Create Anonymous Post</h3>
                <button onclick="document.getElementById('newPostModal').classList.add('hidden')"
                    class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form class="p-6" th:action="@{/student/forum/post}" method="post" onsubmit="return validatePost(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Topic</label>
                    <select name="category"
                        class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-primary focus:border-primary">
                        <option value="general">General</option>
                        <option value="anxiety">Anxiety</option>
                        <option value="stress">Stress</option>
                        <option value="depression">Depression</option>
                        <option value="academic">Academic</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Title</label>
                    <input type="text" name="title" placeholder="Give your post a title..."
                        class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-primary focus:border-primary"
                        required />
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Content</label>
                    <textarea name="content" rows="4" placeholder="Share your thoughts..."
                        class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-primary focus:border-primary"
                        required></textarea>
                </div>
                <div class="mb-6">
                    <label class="flex items-center gap-2 text-sm cursor-pointer">
                        <input type="checkbox" name="anonymous" value="true" class="rounded border-slate-300 text-primary focus:ring-primary" checked />
                        <span class="material-symbols-outlined text-base">visibility_off</span>
                        <span class="text-slate-700 dark:text-slate-300">Post anonymously (your identity will remain hidden)</span>
                    </label>
                </div>
                <button type="submit"
                    class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-colors">Post</button>
            </form>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast"
        class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50">
        <span class="material-symbols-outlined">check_circle</span>
        <span id="toastMessage">Action completed!</span>
    </div>

    <!-- Flag/Report Modal -->
    <div id="reportModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-900 rounded-xl w-full max-w-md">
            <div class="p-6 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Report Post</h3>
                <button onclick="closeReportModal()"
                    class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="reportPostId" />
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Reason for reporting</label>
                    <select id="reportReason"
                        class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-primary focus:border-primary">
                        <option value="">-- Select a reason --</option>
                        <option value="Inappropriate Content">Inappropriate Content</option>
                        <option value="Spam or Advertising">Spam or Advertising</option>
                        <option value="Harassment or Bullying">Harassment or Bullying</option>
                        <option value="Misinformation">Misinformation</option>
                        <option value="Off-Topic">Off-Topic</option>
                        <option value="Violates Community Guidelines">Violates Community Guidelines</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button
                        class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition-colors"
                        onclick="submitReport()">
                        Report Post
                    </button>
                    <button
                        class="flex-1 px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-medium rounded-lg transition-colors"
                        onclick="closeReportModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-900 rounded-xl w-full max-w-md">
            <div class="p-6 border-b border-slate-200 dark:border-slate-800">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-red-500">warning</span>
                    Confirm Delete
                </h3>
            </div>
            <div class="p-6">
                <p class="text-slate-700 dark:text-slate-300 mb-6">
                    Are you sure you want to permanently delete this post? This action cannot be undone.
                </p>
                <input type="hidden" id="deletePostId" />
                <div class="flex gap-3">
                    <button
                        class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition-colors"
                        onclick="submitDelete()">
                        Delete Post
                    </button>
                    <button
                        class="flex-1 px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-medium rounded-lg transition-colors"
                        onclick="closeDeleteModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function togglePendingPosts() {
            const container = document.getElementById('pendingPostsContainer');
            const items = container.querySelectorAll('.pending-post-item');
            const button = document.getElementById('togglePendingBtn');
            const isExpanded = button.getAttribute('data-expanded') === 'true';
            
            items.forEach((item, index) => {
                if (isExpanded) {
                    // Currently expanded, collapse to show only first 3
                    if (index >= 3) {
                        item.classList.add('hidden');
                    }
                } else {
                    // Currently collapsed, expand to show all
                    item.classList.remove('hidden');
                }
            });
            
            const totalCount = items.length;
            button.setAttribute('data-expanded', !isExpanded);
            button.innerHTML = isExpanded ? `View All (<span>${totalCount}</span>)` : 'Hide';
        }

        function deletePost(postId) {
            document.getElementById('deletePostId').value = postId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }

        function submitDelete() {
            const postId = document.getElementById('deletePostId').value;
            closeDeleteModal();

            fetch(`/student/forum/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `postId=${postId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast(data.message || 'Post deleted successfully');
                    // Refresh the page after a short delay to update pending posts section
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert(data.message || 'Error deleting post');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete post');
            });
        }

        function toggleComments(button) {
            const commentsSection = button.parentElement.parentElement.querySelector('.comments-section');
            if (commentsSection) {
                commentsSection.classList.toggle('hidden');
            }
        }

        function likePost(postId) {
            const postEl = document.querySelector(`[data-post-id="${postId}"]`);
            const likeBtn = postEl?.querySelector('.like-btn');
            
            // Debounce: prevent rapid clicks
            if (likeBtn?.hasAttribute('data-liking')) {
                return;
            }
            likeBtn?.setAttribute('data-liking', 'true');
            
            fetch(`/student/forum/like/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && postEl) {
                    const likeCount = likeBtn.querySelector('.like-count');
                    const icon = likeBtn.querySelector('.material-symbols-outlined');
                    likeCount.textContent = data.likeCount;
                    if (data.liked) {
                        likeBtn.classList.add('text-red-500');
                        // Trigger small pop animation on like
                        if (icon) {
                            icon.classList.remove('like-pop');
                            // force reflow to restart animation if already applied
                            // eslint-disable-next-line no-unused-expressions
                            icon.offsetWidth;
                            icon.classList.add('like-pop');
                        }
                    } else {
                        likeBtn.classList.remove('text-red-500');
                        // Optionally remove any lingering animation class
                        if (icon) {
                            icon.classList.remove('like-pop');
                        }
                    }
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                // Re-enable button after request completes
                likeBtn?.removeAttribute('data-liking');
            });
        }

        function addComment(postId, button) {
            const container = button.parentElement;
            const input = container.querySelector('.comment-input');
            const anonymousCheckbox = container.parentElement.querySelector('.comment-anonymous-checkbox');
            const content = input.value.trim();
            const anonymous = anonymousCheckbox ? anonymousCheckbox.checked : true;
            
            if (!content) {
                alert('Please write a comment');
                return;
            }

            fetch(`/student/forum/comment/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `content=${encodeURIComponent(content)}&anonymous=${anonymous}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const postEl = document.querySelector(`[data-post-id="${postId}"]`);
                    if (postEl) {
                        // Update comment count
                        const commentBtn = postEl.querySelector('button .comment-count');
                        if (commentBtn) {
                            const currentCount = parseInt(commentBtn.textContent) || 0;
                            commentBtn.textContent = currentCount + 1;
                        }
                    }
                    
                    const commentsContainer = button.parentElement.parentElement;
                    const newComment = document.createElement('div');
                    newComment.className = 'bg-slate-50 dark:bg-slate-800 p-3 rounded-lg comment-item';
                    newComment.innerHTML = `
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium text-sm">${data.comment.authorName}</span>
                            <span class="text-xs text-slate-400">• ${data.comment.timeAgo}</span>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400">${data.comment.content}</p>
                    `;
                    commentsContainer.insertBefore(newComment, button.parentElement);
                    input.value = '';
                    showToast('Comment added successfully!');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function reportPost(postId) {
            openReportModal(postId);
        }

        function openReportModal(postId) {
            document.getElementById('reportPostId').value = postId;
            document.getElementById('reportReason').value = '';
            document.getElementById('reportModal').classList.remove('hidden');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        function submitReport() {
            const postId = document.getElementById('reportPostId').value;
            const reason = document.getElementById('reportReason').value;

            if (!reason) {
                alert('Please select a reason for reporting this post');
                return;
            }

            fetch(`/student/forum/flag/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `reason=${encodeURIComponent(reason)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    closeReportModal();
                    showToast('Post reported successfully');
                    // Refresh after 1.5s to show updated button state
                    setTimeout(() => location.reload(), 1500);
                } else if (data.message && data.message.includes('already')) {
                    // This shouldn't happen due to disabled button, but handle gracefully
                    closeReportModal();
                } else {
                    alert(data.message || 'Error reporting post');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to report post');
            });
        }

        function validatePost(event) {
            const title = event.target.querySelector('input[name="title"]').value.trim();
            const content = event.target.querySelector('textarea[name="content"]').value.trim();

            if (!title || !content) {
                alert('Please fill in all fields');
                return false;
            }
            return true;
        }

        function showToast(message) {
            const toast = document.getElementById('successToast');
            const msg = document.getElementById('toastMessage');
            msg.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function loadMoreComments(button, postId) {
            const postEl = document.querySelector(`[data-post-id="${postId}"]`);
            const commentItems = postEl.querySelectorAll('.comment-item');
            let hiddenCount = 0;
            
            commentItems.forEach(item => {
                if (item.classList.contains('hidden')) {
                    item.classList.remove('hidden');
                    hiddenCount++;
                }
            });
            
            // Remove the "Load more" button after showing all
            button.parentElement.remove();
        }
    </script>
</body>

</html>