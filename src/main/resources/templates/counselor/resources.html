<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: head('Manage Resources - MindWell Counselor')}">
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-text-primary-light dark:text-text-primary-dark transition-colors duration-300">
    <div class="flex h-screen">
        <div th:replace="~{fragments/sidebar-counselor :: sidebar('resources')}"></div>

        <main class="flex-1 overflow-y-auto">
            <header
                class="h-16 flex items-center justify-between px-8 border-b border-border-light dark:border-border-dark sticky top-0 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm">
                <div>
                    <h2 class="text-2xl font-bold">Resource Management</h2>
                    <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Upload and manage mental
                        health resources</p>
                </div>
                <button
                    class="flex items-center gap-2 bg-primary text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-indigo-700 transition-colors"
                    onclick="document.getElementById('uploadModal').classList.remove('hidden')">
                    <span class="material-symbols-outlined">upload</span>
                    Upload Resource
                </button>
            </header>

            <div class="p-8">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div
                        class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-border-light dark:border-border-dark">
                        <p id="totalResourcesCount" class="text-3xl font-bold text-primary">0</p>
                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Total Resources</p>
                    </div>
                    <div
                        class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-border-light dark:border-border-dark">
                        <p id="videosCount" class="text-3xl font-bold text-purple-500">0</p>
                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Videos</p>
                    </div>
                    <div
                        class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-border-light dark:border-border-dark">
                        <p id="articlesCount" class="text-3xl font-bold text-teal-500">0</p>
                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Articles</p>
                    </div>
                    <div
                        class="bg-surface-light dark:bg-surface-dark p-5 rounded-xl border border-border-light dark:border-border-dark">
                        <p id="guidesCount" class="text-3xl font-bold text-amber-500">0</p>
                        <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Guides</p>
                    </div>
                </div>

                <!-- Resources Table -->
                <div
                    class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-border-light dark:border-border-dark">
                                <th
                                    class="text-left px-6 py-4 text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">
                                    Resource</th>
                                <th
                                    class="text-left px-6 py-4 text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">
                                    Type</th>
                                <th
                                    class="text-left px-6 py-4 text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">
                                    Category</th>
                                <!-- Views column removed -->
                                <th
                                    class="text-left px-6 py-4 text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resourcesTableBody">
                            <!-- populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-surface-light dark:bg-surface-dark rounded-xl w-full max-w-lg">
            <div class="p-6 border-b border-border-light dark:border-border-dark flex justify-between items-center">
                <h3 class="text-xl font-bold">Upload Resource</h3>
                <button onclick="document.getElementById('uploadModal').classList.add('hidden')"
                    class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <form id="uploadForm" class="p-6" th:action="@{/counselor/resources/upload}" method="post">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Title</label>
                    <input id="resourceTitle" type="text" name="resourceTitle" required
                        class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-800 border border-border-light dark:border-border-dark rounded-lg" />
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Type</label>
                        <select id="resourceType" name="resourceType" required onchange="toggleUrlField()"
                            class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-800 border border-border-light dark:border-border-dark rounded-lg">
                            <option value="article">Article</option>
                            <option value="video">Video</option>
                            <option value="guide">Guide</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Category</label>
                        <select name="category"
                            class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-800 border border-border-light dark:border-border-dark rounded-lg">
                            <option>Anxiety</option>
                            <option>Depression</option>
                            <option>Stress</option>
                            <option>Mindfulness</option>
                            <option>Relationships</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <textarea id="description" name="description" rows="3"
                        class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-800 border border-border-light dark:border-border-dark rounded-lg"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Cover Image (Optional)</label>
                    <input type="hidden" id="coverImageUrl" name="coverImageUrl" value="">
                    <div class="grid grid-cols-3 gap-3">
                        <div onclick="selectBackground('')" 
                            class="background-option cursor-pointer border-2 border-transparent hover:border-primary rounded-lg overflow-hidden transition-all" 
                            data-value="">
                            <div class="aspect-video bg-gradient-to-br from-purple-400 to-indigo-500 flex items-center justify-center">
                                <span class="text-white text-xs font-semibold">Default</span>
                            </div>
                        </div>
                        <div onclick="selectBackground('/assets/background1.jpeg')" 
                            class="background-option cursor-pointer border-2 border-transparent hover:border-primary rounded-lg overflow-hidden transition-all" 
                            data-value="/assets/background1.jpeg">
                            <img src="/assets/background1.jpeg" alt="Background 1" class="w-full h-full object-cover aspect-video">
                        </div>
                        <div onclick="selectBackground('/assets/background2.jpeg')" 
                            class="background-option cursor-pointer border-2 border-transparent hover:border-primary rounded-lg overflow-hidden transition-all" 
                            data-value="/assets/background2.jpeg">
                            <img src="/assets/background2.jpeg" alt="Background 2" class="w-full h-full object-cover aspect-video">
                        </div>
                        <div onclick="selectBackground('/assets/background3.jpeg')" 
                            class="background-option cursor-pointer border-2 border-transparent hover:border-primary rounded-lg overflow-hidden transition-all" 
                            data-value="/assets/background3.jpeg">
                            <img src="/assets/background3.jpeg" alt="Background 3" class="w-full h-full object-cover aspect-video">
                        </div>
                        <div onclick="selectBackground('/assets/background4.jpeg')" 
                            class="background-option cursor-pointer border-2 border-transparent hover:border-primary rounded-lg overflow-hidden transition-all" 
                            data-value="/assets/background4.jpeg">
                            <img src="/assets/background4.jpeg" alt="Background 4" class="w-full h-full object-cover aspect-video">
                        </div>
                        <div onclick="selectBackground('/assets/background5.jpeg')" 
                            class="background-option cursor-pointer border-2 border-transparent hover:border-primary rounded-lg overflow-hidden transition-all" 
                            data-value="/assets/background5.jpeg">
                            <img src="/assets/background5.jpeg" alt="Background 5" class="w-full h-full object-cover aspect-video">
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Click to select a background image for your resource card</p>
                </div>
                <div id="urlField" class="mb-6 hidden">
                    <label class="block text-sm font-medium mb-2">Link / URL</label>
                    <input id="resourceUrl" type="url" name="resourceUrl" placeholder="https://..."
                        class="w-full px-4 py-2 bg-slate-100 dark:bg-slate-800 border border-border-light dark:border-border-dark rounded-lg" />
                    <input type="hidden" id="resourceId" name="resourceId" />
                    <p class="text-xs text-slate-500 mt-1">For YouTube videos, paste the full YouTube URL. The thumbnail will be automatically extracted.</p>
                </div>
                <button type="submit"
                    class="w-full bg-primary text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-colors">Upload
                    Resource</button>
            </form>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageToast" class="hidden fixed bottom-4 right-4 z-50">
        <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2">
            <span class="material-symbols-outlined">check_circle</span>
            <span id="messageText">Resource uploaded successfully!</span>
        </div>
    </div>

    <script>
        // Check for URL parameters and show messages
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('success') === 'uploaded') {
                showMessage('Resource uploaded successfully!', 'success');
                // Clear the form
                document.getElementById('uploadModal').classList.add('hidden');
                try { new BroadcastChannel('mentalmind-resources').postMessage({type: 'resources-updated'}); } catch(e) {}
            } else if (urlParams.get('success') === 'updated') {
                showMessage('Resource updated successfully!', 'success');
                document.getElementById('uploadModal').classList.add('hidden');
                try { new BroadcastChannel('mentalmind-resources').postMessage({type: 'resources-updated'}); } catch(e) {}
            } else if (urlParams.get('error') === 'invalid') {
                showMessage('Please fill in all required fields.', 'error');
            } else if (urlParams.get('error') === 'upload_failed') {
                showMessage('Failed to upload resource. Please try again.', 'error');
            }
        });

        function showMessage(message, type) {
            const toast = document.getElementById('messageToast');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = message;
            
            if (type === 'error') {
                toast.querySelector('div').className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2';
                toast.querySelector('span').textContent = 'error';
            } else {
                toast.querySelector('div').className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2';
                toast.querySelector('span').textContent = 'check_circle';
            }
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        }
    </script>
    <script>
        // Background selection
        function selectBackground(value) {
            document.getElementById('coverImageUrl').value = value;
            // Remove selected state from all options
            document.querySelectorAll('.background-option').forEach(opt => {
                opt.classList.remove('border-primary', 'ring-2', 'ring-primary');
                opt.classList.add('border-transparent');
            });
            // Add selected state to clicked option
            const selected = document.querySelector(`[data-value="${value}"]`);
            if (selected) {
                selected.classList.remove('border-transparent');
                selected.classList.add('border-primary', 'ring-2', 'ring-primary');
            }
        }

        // Load resources into table
        function toggleUrlField() {
            const type = document.getElementById('resourceType').value;
            const urlField = document.getElementById('urlField');
            if (type === 'video') {
                urlField.classList.remove('hidden');
            } else {
                urlField.classList.add('hidden');
                // clear url when not video
                const input = document.getElementById('resourceUrl');
                if (input) input.value = '';
            }
        }

        async function loadResourcesTable() {
            try {
                const res = await fetch('/counselor/api/resources');
                if (!res.ok) throw new Error('Failed to load resources');
                const resources = await res.json();
                // Update counts
                const total = resources.length;
                const videos = resources.filter(r => r.type === 'video').length;
                const articles = resources.filter(r => r.type === 'article').length;
                const guides = resources.filter(r => r.type === 'guide').length;
                document.getElementById('totalResourcesCount').textContent = total;
                document.getElementById('videosCount').textContent = videos;
                document.getElementById('articlesCount').textContent = articles;
                document.getElementById('guidesCount').textContent = guides;

                const tbody = document.getElementById('resourcesTableBody');
                tbody.innerHTML = '';
                resources.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-border-light dark:border-border-dark hover:bg-slate-50 dark:hover:bg-slate-800/50';
                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <p class="font-semibold">${r.title}</p>
                            <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark">${r.createdAt ? r.createdAt.substring(0,10) : ''}</p>
                        </td>
                        <td class="px-6 py-4"><span class="text-xs font-medium bg-${r.badgeColor}-100 dark:bg-${r.badgeColor}-900/50 text-${r.badgeColor}-600 px-2 py-1 rounded-full">${r.type}</span></td>
                        <td class="px-6 py-4 text-text-secondary-light dark:text-text-secondary-dark">${r.category ? r.category : '-'}</td>
                        <!-- Views column removed -->
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="onEdit(${r.id})" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><span class="material-symbols-outlined text-base">edit</span></button>
                                <button onclick="onDelete(${r.id})" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg text-red-500"><span class="material-symbols-outlined text-base">delete</span></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error(e);
            }
        }

        function onEdit(id) {
            // fetch resource and prefill form, then switch form action to update
            fetch(`/counselor/api/resources/${id}`)
                .then(r => r.json())
                .then(data => {
                    const resource = Array.isArray(data) ? data[0] : data; // handle optional
                    document.getElementById('resourceTitle').value = resource.title || '';
                    document.getElementById('resourceType').value = resource.type || 'article';
                    document.getElementById('description').value = resource.description || '';
                    // Attempt to extract original URL from content if possible
                    document.getElementById('resourceUrl').value = '';
                    document.getElementById('resourceId').value = resource.id;
                    // Set form action to update endpoint
                    document.getElementById('uploadForm').action = '/counselor/resources/update';
                    // Show or hide URL input depending on type
                    toggleUrlField();
                    document.getElementById('uploadModal').classList.remove('hidden');
                })
                .catch(err => console.error(err));
        }

        function onDelete(id) {
            if (!confirm('Delete this resource?')) return;
            const body = `resourceId=${id}`;
            fetch('/counselor/resources/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body
            }).then(r => {
                if (r.ok) {
                    loadResourcesTable();
                    showMessage('Resource deleted', 'success');
                    try { new BroadcastChannel('mentalmind-resources').postMessage({type: 'resources-updated'}); } catch(e) {}
                } else {
                    showMessage('Delete failed', 'error');
                }
            }).catch(err => {
                console.error(err);
                showMessage('Delete failed', 'error');
            });
        }

        // When showing upload modal for new resource, reset form action
        document.querySelector('button[onclick="document.getElementById(\'uploadModal\').classList.remove(\'hidden\')"]').addEventListener('click', () => {
            document.getElementById('uploadForm').action = '/counselor/resources/upload';
            document.getElementById('resourceId').value = '';
            document.getElementById('resourceTitle').value = '';
            document.getElementById('resourceType').value = 'article';
            document.getElementById('description').value = '';
            document.getElementById('resourceUrl').value = '';
            toggleUrlField();
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', loadResourcesTable);
    </script>
</body>

</html>