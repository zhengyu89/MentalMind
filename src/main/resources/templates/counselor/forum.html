<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: head('Forum Management - MindWell Counselor')}">
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-700 dark:text-slate-300 antialiased">
    <div class="flex h-screen">
        <div th:replace="~{fragments/sidebar-counselor :: sidebar('forum')}"></div>

        <main class="flex-1 p-8 overflow-y-auto">
            <header class="flex justify-between items-start mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white">Forum Management</h2>
                    <p class="text-slate-500 dark:text-slate-400 mt-1">Review and moderate the peer support forum.</p>
                </div>
                <a th:href="@{/counselor/forum/moderation}"
                    class="relative flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white font-semibold px-5 py-3 rounded-lg transition-colors">
                    <span class="material-symbols-outlined">pending_actions</span>
                    Forum Moderation
                    <span th:if="${moderationCount > 0}" 
                        class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center"
                        th:text="${moderationCount}">0</span>
                </a>
            </header>

            <style>
                .clamp-3 {
                    display: -webkit-box;
                    -webkit-line-clamp: 3;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                }
            </style>

            <!-- Forum Topics/Tabs -->
            <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                <a th:href="@{/counselor/forum}"
                    th:classappend="${selectedCategory == 'all'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    All Topics
                </a>
                <a th:href="@{/counselor/forum(category='anxiety')}"
                    th:classappend="${selectedCategory == 'anxiety'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    Anxiety
                </a>
                <a th:href="@{/counselor/forum(category='stress')}"
                    th:classappend="${selectedCategory == 'stress'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    Stress
                </a>
                <a th:href="@{/counselor/forum(category='depression')}"
                    th:classappend="${selectedCategory == 'depression'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    Depression
                </a>
                <a th:href="@{/counselor/forum(category='academic')}"
                    th:classappend="${selectedCategory == 'academic'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'"
                    class="px-4 py-2 rounded-full font-medium whitespace-nowrap">
                    Academic
                </a>
            </div>

            <!-- Sorting Controls -->
            <div class="flex justify-end gap-2 mb-6">
                <div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400">
                    <span>Sort by:</span>
                    <a th:href="@{/counselor/forum(category=${selectedCategory}, sort='time')}"
                        th:classappend="${sortBy == 'time' or sortBy == null} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800'"
                        class="px-3 py-1.5 rounded-lg font-medium text-sm hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                        <span class="material-symbols-outlined text-sm">schedule</span>
                        Newest
                    </a>
                    <a th:href="@{/counselor/forum(category=${selectedCategory}, sort='likes')}"
                        th:classappend="${sortBy == 'likes'} ? 'bg-primary text-white' : 'bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800'"
                        class="px-3 py-1.5 rounded-lg font-medium text-sm hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                        <span class="material-symbols-outlined text-sm">favorite</span>
                        Most Liked
                    </a>
                </div>
            </div>

            <div id="postsList" class="space-y-4">
                <div th:if="${posts.isEmpty()}" class="text-center py-12">
                    <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">comment</span>
                    <p class="text-slate-500 text-lg">No approved posts yet.</p>
                </div>

                <div th:each="post : ${posts}"
                    class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800"
                    th:attr="data-post-id=${post.id}">
                    <div class="flex items-start gap-4">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full flex items-center justify-center text-white font-bold">
                            <span th:text="${post.authorDisplayName.charAt(0)}">A</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="font-semibold text-slate-900 dark:text-white"
                                    th:text="${post.authorDisplayName}">Anonymous</span>
                                <span class="text-xs text-slate-400" th:text="'• ' + ${post.timeAgo}">• 2 hours ago</span>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-purple-600 bg-purple-100 dark:bg-purple-900/50"
                                    th:text="${post.category.substring(0, 1).toUpperCase() + post.category.substring(1)}">Anxiety</span>
                                <span th:if="${post.flagCount > 0}" 
                                    class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 dark:bg-red-900/50 text-red-600 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">flag</span>
                                    <span th:text="${post.flagCount}">0</span>
                                </span>
                            </div>
                            <h4 class="text-lg font-semibold text-slate-800 dark:text-white mb-2 cursor-pointer hover:text-primary transition-colors" 
                                th:text="${post.title}"
                                th:onclick="|window.location.href='/counselor/forum/${post.id}'|">
                                Post Title
                            </h4>
                            <p class="text-slate-600 dark:text-slate-400 clamp-3" th:text="${post.content}">Post content goes
                                here</p>
                            <a th:if="${#strings.length(post.content) > 200}"
                               th:href="@{'/counselor/forum/' + ${post.id}}"
                               class="mt-2 inline-flex items-center text-primary hover:text-indigo-700 text-sm font-medium">
                                Show more
                                <span class="material-symbols-outlined text-sm ml-1">chevron_right</span>
                            </a>
                            <div class="flex items-center gap-6 mt-4">
                                <div class="flex items-center gap-1 text-slate-500">
                                    <span class="material-symbols-outlined text-xl">favorite</span>
                                    <span th:text="${post.likeCount}">0</span>
                                </div>
                                <div class="flex items-center gap-1 text-slate-500">
                                    <span class="material-symbols-outlined text-xl">chat_bubble</span>
                                    <span th:text="${post.commentCount}">0</span>
                                    <span>replies</span>
                                </div>
                                <!-- Moderation Controls -->
                                <button
                                    th:disabled="${userFlaggedPosts != null && userFlaggedPosts[post.id]}"
                                    th:classappend="${userFlaggedPosts != null && userFlaggedPosts[post.id]} ? 'opacity-50 cursor-not-allowed' : ''"
                                    class="flex items-center gap-1 text-slate-500 hover:text-red-500 transition-colors ml-auto h-fit disabled:hover:text-slate-500"
                                    th:attr="onclick=!${userFlaggedPosts != null && userFlaggedPosts[post.id]} ? 'flagPost(' + ${post.id} + ')' : ''">
                                    <span class="material-symbols-outlined text-xl">flag</span>
                                    <span class="text-sm" th:text="${userFlaggedPosts != null && userFlaggedPosts[post.id]} ? 'Already Reported' : 'Report'">Report</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Flag Modal -->
    <div id="flagModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-900 rounded-xl w-full max-w-md">
            <div class="p-6 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Report Post</h3>
                <button onclick="closeFlagModal()"
                    class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="flagPostId" />
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Reason for reporting</label>
                    <select id="flagReason"
                        class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-primary focus:border-primary">
                        <option value="">-- Select a reason --</option>
                        <option value="Inappropriate Content">Inappropriate Content</option>
                        <option value="Spam or Advertising">Spam or Advertising</option>
                        <option value="Harassment or Bullying">Harassment or Bullying</option>
                        <option value="Misinformation">Misinformation</option>
                        <option value="Off-Topic">Off-Topic</option>
                        <option value="Violates Community Guidelines">Violates Community Guidelines</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button
                        class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-medium rounded-lg transition-colors"
                        onclick="submitFlag()">
                        Report Post
                    </button>
                    <button
                        class="flex-1 px-4 py-2 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 font-medium rounded-lg transition-colors"
                        onclick="closeFlagModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="hidden fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50">
        <span class="material-symbols-outlined">check_circle</span>
        <span id="toastMessage">Action completed!</span>
    </div>

    <script>
        function flagPost(postId) {
            document.getElementById('flagPostId').value = postId;
            document.getElementById('flagReason').value = '';
            document.getElementById('flagModal').classList.remove('hidden');
        }

        function closeFlagModal() {
            document.getElementById('flagModal').classList.add('hidden');
        }

        function submitFlag() {
            const postId = document.getElementById('flagPostId').value;
            const reason = document.getElementById('flagReason').value;
            
            if (!reason) {
                alert('Please select a reason for flagging this post');
                return;
            }

            fetch(`/counselor/forum/moderate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `postId=${postId}&action=flag&moderationNote=${encodeURIComponent(reason)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    closeFlagModal();
                    showToast('Post reported successfully');
                    // Refresh after 1.5s to show updated flag count
                    setTimeout(() => location.reload(), 1500);
                } else if (data.message && data.message.includes('already')) {
                    // This shouldn't happen due to disabled button, but handle gracefully
                    closeFlagModal();
                } else {
                    alert(data.message || 'Error reporting post');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to report post');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('successToast');
            const msg = document.getElementById('toastMessage');
            msg.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>

</html>
